# HardwareTestForm 硬件设备测试窗体使用说明

## 📋 目录
- [启动测试窗体](#启动测试窗体)
- [Modbus TCP 测试](#modbus-tcp-测试)
- [通用TCP 测试](#通用tcp-测试)
- [模拟器测试](#模拟器测试)
- [常见问题](#常见问题)

---

## 🚀 启动测试窗体

### 方法1: 临时启动（推荐）

1. 打开 `COTUI/Program.cs` 文件

2. 修改 `Main` 方法，临时注释主窗体：

```csharp
static void Main()
{
    Application.EnableVisualStyles();
    Application.SetCompatibleTextRenderingDefault(false);
    
    // 【临时测试】硬件设备测试窗体
    Application.Run(new COTUI.Form.HardwareTestForm());
    
    // 【正式运行】主窗体
    // Application.Run(new MainForm());
}
```

3. 按 `F5` 运行项目

4. 测试完成后，恢复注释即可

### 方法2: 菜单启动

在主窗体中添加测试菜单：

```csharp
private void btnHardwareTest_Click(object sender, EventArgs e)
{
    var testForm = new HardwareTestForm();
    testForm.ShowDialog();
}
```

---

## 🔧 Modbus TCP 测试

### 适用设备
- PLC（西门子、三菱、欧姆龙等）
- IO模块（研华、泓格等）
- 变频器
- 温控器
- 支持Modbus TCP协议的传感器

### 测试步骤

#### 1. 连接设备

**界面操作：**
```
┌─────────────────────────────────────────────┐
│ IP地址: [192.168.1.10]  端口: [502]         │
│ [连接]  [断开]  状态: 未连接               │
└─────────────────────────────────────────────┘
```

**步骤：**
1. 输入设备IP地址（如：`192.168.1.10`）
2. 输入端口号（Modbus TCP标准端口：`502`）
3. 点击 **[连接]** 按钮
4. 观察状态显示：`已连接`（绿色）

**日志输出示例：**
```
[14:25:30] 正在连接到 MQTT 服务器 192.168.1.10:502...
[14:25:30] 连接成功
```

#### 2. 读取线圈（Digital Output）

**界面操作：**
```
┌─────────────────────────────────────────────┐
│ 从站地址: [1]  起始地址: [0]  数量: [10]   │
│ [读取线圈]  [读取寄存器]                    │
└─────────────────────────────────────────────┘
```

**步骤：**
1. **从站地址**: 输入 `1`（通常PLC从站地址为1）
2. **起始地址**: 输入 `0`（要读取的第一个线圈地址）
3. **数量**: 输入 `10`（读取10个线圈）
4. 点击 **[读取线圈]** 按钮

**日志输出示例：**
```
[14:26:15] 读取线圈成功 [0-9]:
[14:26:15]   地址 0: ON
[14:26:15]   地址 1: OFF
[14:26:15]   地址 2: ON
[14:26:15]   地址 3: OFF
...
```

**功能码：** `0x01` (Read Coils)

#### 3. 读取寄存器（Analog Input/Output）

**步骤：**
1. **从站地址**: `1`
2. **起始地址**: `0`（第一个寄存器）
3. **数量**: `10`（读取10个寄存器）
4. 点击 **[读取寄存器]** 按钮

**日志输出示例：**
```
[14:27:00] 读取寄存器成功 [0-9]:
[14:27:00]   地址 0: 1250 (0x04E2)
[14:27:00]   地址 1: 0 (0x0000)
[14:27:00]   地址 2: 32768 (0x8000)
[14:27:00]   地址 3: 100 (0x0064)
...
```

**功能码：** `0x03` (Read Holding Registers)

#### 4. 写入线圈

**步骤：**
1. **从站地址**: `1`
2. **起始地址**: `100`（要写入的线圈地址）
3. 点击 **[写入线圈]** 按钮
4. 在弹出对话框中选择：
   - **是** → 写入 `ON` (0xFF00)
   - **否** → 写入 `OFF` (0x0000)

**日志输出示例：**
```
[14:28:30] 写入线圈 100: ON - 成功
```

**功能码：** `0x05` (Write Single Coil)

#### 5. 写入寄存器

**步骤：**
1. **从站地址**: `1`
2. **起始地址**: `200`（要写入的寄存器地址）
3. 点击 **[写入寄存器]** 按钮
4. 在输入框中输入数值（范围：`0-65535`），如：`1234`
5. 点击确定

**日志输出示例：**
```
[14:29:15] 写入寄存器 200: 1234 - 成功
```

**功能码：** `0x06` (Write Single Register)

---

## 🌐 通用TCP 测试

### 适用设备
- Cognex/Keyence 视觉系统
- 雷赛/固高运动控制卡
- 激光打标机
- 自定义TCP协议设备

### 测试步骤

#### 1. 连接设备

**界面操作：**
```
┌─────────────────────────────────────────────┐
│ IP地址: [192.168.1.20]  端口: [3000]        │
│ [连接]  [断开]  状态: 未连接               │
└─────────────────────────────────────────────┘
```

**步骤：**
1. 输入设备IP（如：`192.168.1.20`）
2. 输入端口号（根据设备手册，如：`3000`）
3. 点击 **[连接]** 按钮

#### 2. 发送命令

**界面操作：**
```
┌─────────────────────────────────────────────┐
│ 命令: [TRIGGER\r\n]            [发送]       │
└─────────────────────────────────────────────┘
```

**常用命令格式：**

| 设备类型 | 命令示例 | 说明 |
|---------|---------|------|
| 视觉系统 | `TRIGGER\r\n` | 触发拍照 |
| 视觉系统 | `READ\r\n` | 读取结果 |
| 运动控制卡 | `MOVE X100\r\n` | 移动X轴到100 |
| 激光打标 | `MARK START\r\n` | 开始打标 |

**特殊字符说明：**
- `\r` → 回车符（CR）
- `\n` → 换行符（LF）
- `\t` → 制表符（Tab）

**步骤：**
1. 在命令框输入命令（如：`TRIGGER\r\n`）
2. 点击 **[发送]** 按钮
3. 观察日志窗口的发送/接收记录

**日志输出示例：**
```
[14:30:00] 连接成功
[14:30:05] → 发送: TRIGGER\r\n - 成功
[14:30:06] ← 接收: OK\r\n
[14:30:10] → 发送: READ\r\n - 成功
[14:30:11] ← 接收: RESULT:PASS,X:123,Y:456\r\n
```

#### 3. 查看接收数据

所有从设备接收的数据会实时显示在日志窗口中，包括：
- 时间戳
- 数据内容（自动显示转义字符）
- 数据长度

---

## 🔍 模拟器测试

### 如果没有真实硬件设备，可使用模拟器进行测试

### Modbus TCP 模拟器

#### Windows - ModbusSim

1. **下载：** [ModbusSim](https://sourceforge.net/projects/modrssim/)
2. **安装运行**
3. **配置：**
   ```
   Protocol: Modbus TCP
   Port: 502
   Slave ID: 1
   ```
4. **在测试窗体中连接：**
   - IP地址: `127.0.0.1`
   - 端口: `502`

#### 在线模拟器

- [DiagSlave](https://www.modbusdriver.com/diagslave.html)
- [Modbus Slave](https://www.modbustools.com/modbus_slave.html)

### 通用TCP 模拟器

#### Windows - Hercules

1. **下载：** [Hercules SETUP utility](https://www.hw-group.com/software/hercules-setup-utility)
2. **配置TCP Server：**
   ```
   Port: 3000
   Protocol: TCP
   ```
3. **在测试窗体中连接：**
   - IP地址: `127.0.0.1`
   - 端口: `3000`

#### macOS/Linux - netcat

```bash
# 启动TCP服务器（监听3000端口）
nc -l 3000

# 或使用详细模式
nc -l -v 3000
```

#### Python 简易服务器

```python
# tcp_server.py
import socket

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(('0.0.0.0', 3000))
server.listen(1)
print("TCP Server listening on port 3000...")

while True:
    client, addr = server.accept()
    print(f"连接来自: {addr}")
    
    while True:
        data = client.recv(1024)
        if not data:
            break
        print(f"接收: {data.decode()}")
        client.send(b"OK\r\n")  # 回复
```

运行：
```bash
python tcp_server.py
```

---

## ❓ 常见问题

### Q1: 连接失败，显示"连接超时"

**可能原因：**
- ❌ IP地址或端口号错误
- ❌ 设备未开机或网络未连接
- ❌ 防火墙阻止了连接
- ❌ 设备不支持TCP连接

**解决方法：**
1. 使用 `ping` 测试网络：
   ```bash
   ping 192.168.1.10
   ```
2. 使用 `telnet` 测试端口：
   ```bash
   telnet 192.168.1.10 502
   ```
3. 检查Windows防火墙设置
4. 确认设备IP地址（查看设备网络配置）

### Q2: Modbus读取返回NULL或失败

**可能原因：**
- ❌ 从站地址不正确
- ❌ 寄存器地址超出范围
- ❌ 设备不支持该功能码

**解决方法：**
1. 确认从站地址（查看PLC配置，通常为1）
2. 查看设备手册确认寄存器地址范围
3. 尝试不同的功能码：
   - 读取线圈 (0x01)
   - 读取保持寄存器 (0x03)
   - 读取输入寄存器 (0x04)

### Q3: 通用TCP发送成功但无响应

**可能原因：**
- ❌ 命令格式错误
- ❌ 缺少结束符（\r\n）
- ❌ 设备需要特定的握手协议

**解决方法：**
1. 查看设备通信协议文档
2. 确认命令格式和结束符
3. 使用Wireshark抓包分析通信过程

### Q4: 连接后立即断开

**可能原因：**
- ❌ 设备连接数已满
- ❌ 设备要求身份验证
- ❌ 通信协议不匹配

**解决方法：**
1. 断开其他连接到该设备的客户端
2. 检查设备是否需要登录验证
3. 确认使用正确的协议（Modbus/自定义）

### Q5: 中文乱码

**解决方法：**
```csharp
// 如果设备返回中文，修改编码
// 在 GenericTcpDevice.cs 中：
string text = Encoding.GetEncoding("GB2312").GetString(data);
// 或
string text = Encoding.UTF8.GetString(data);
```

---

## 📊 日志分析

### 正常通信日志示例

```
[14:25:30] 正在连接到 MQTT 服务器 192.168.1.10:502...
[14:25:30] [Modbus-PLC] 连接成功
[14:26:15] 读取线圈成功 [0-9]:
[14:26:15]   地址 0: ON
[14:26:15]   地址 1: OFF
[14:27:00] 读取寄存器成功 [0-9]:
[14:27:00]   地址 0: 1250 (0x04E2)
```

### 错误日志分析

```
[14:25:30] [Modbus-PLC] 连接异常: No connection could be made
→ 网络不通，检查IP和网线

[14:26:15] 读取线圈失败
→ Modbus通信异常，检查从站地址和寄存器地址

[14:27:00] [Vision-01] 连接丢失
→ 设备主动断开，可能是超时或设备重启
```

---

## 🔐 安全提示

1. **生产环境测试：**
   - ⚠️ 谨慎写入线圈和寄存器
   - ⚠️ 先在离线环境测试
   - ⚠️ 确认地址映射关系

2. **网络隔离：**
   - 建议使用独立的测试网络
   - 避免影响生产设备

3. **备份配置：**
   - 写入前记录原始值
   - 测试完成后恢复

---

## 📞 技术支持

如遇到问题，请提供：
1. 设备品牌型号
2. 通信协议（Modbus TCP / 自定义）
3. 错误日志截图
4. 网络拓扑图

---

**最后更新：** 2025-11-29  
**版本：** 1.0
