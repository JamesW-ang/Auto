# å…¨å±€å˜é‡è¿ç§»æŒ‡å—

## ğŸ¯ è¿ç§»ç›®æ ‡

å°†ç°æœ‰ä»£ç ä»é‡å¤è°ƒç”¨å•ä¾‹çš„æ–¹å¼è¿ç§»åˆ°ä½¿ç”¨ `Gvar` å…¨å±€å˜é‡ï¼Œå‡å°‘ä»£ç é‡å¤ï¼Œæå‡å¯è¯»æ€§å’Œæ€§èƒ½ã€‚

---

## ğŸ“‹ è¿ç§»æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å˜é‡è¿ç§»

#### 1. ç”¨æˆ·å˜é‡

**æŸ¥æ‰¾**: `Gvar._User`  
**æ›¿æ¢**: `Gvar.User`

```csharp
// ä¿®æ”¹å‰
Gvar._User = "admin";
string user = Gvar._User;

// ä¿®æ”¹å
Gvar.User = "admin";
string user = Gvar.User;
```

#### 2. å·¥ç«™å˜é‡

**æŸ¥æ‰¾**: `Gvar._CurrentStation`  
**æ›¿æ¢**: `Gvar.CurrentStation`

```csharp
// ä¿®æ”¹å‰
Gvar._CurrentStation = "å·¥ç«™1";
string station = Gvar._CurrentStation;

// ä¿®æ”¹å
Gvar.CurrentStation = "å·¥ç«™1";
string station = Gvar.CurrentStation;
```

---

### ç¬¬äºŒé˜¶æ®µï¼šå•ä¾‹æœåŠ¡è¿ç§»

#### 1. Logger æ—¥å¿—æœåŠ¡

**æŸ¥æ‰¾**: `Logger.GetInstance()`  
**æ›¿æ¢**: `Gvar.Logger`

```csharp
// ä¿®æ”¹å‰
Logger.GetInstance().Info("è¿æ¥æˆåŠŸ");
Logger.GetInstance().Error("è¿æ¥å¤±è´¥", ex);

// ä¿®æ”¹å
Gvar.Logger.Info("è¿æ¥æˆåŠŸ");
Gvar.Logger.Error("è¿æ¥å¤±è´¥", ex);
```

**æ‰¹é‡æ›¿æ¢å‘½ä»¤**ï¼ˆVS Codeï¼‰:
- æŸ¥æ‰¾: `Logger\.GetInstance\(\)`
- æ›¿æ¢: `Gvar.Logger`
- å‹¾é€‰"ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"

#### 2. DatabaseHelper æ•°æ®åº“æœåŠ¡

**æŸ¥æ‰¾**: `DatabaseHelper.Instance`  
**æ›¿æ¢**: `Gvar.DB`

```csharp
// ä¿®æ”¹å‰
DatabaseHelper.Instance.ExecuteQuery("SELECT * FROM Users");
DatabaseHelper.Instance.ExecuteNonQuery("UPDATE ...");

// ä¿®æ”¹å
Gvar.DB.ExecuteQuery("SELECT * FROM Users");
Gvar.DB.ExecuteNonQuery("UPDATE ...");
```

**æ‰¹é‡æ›¿æ¢å‘½ä»¤**ï¼ˆVS Codeï¼‰:
- æŸ¥æ‰¾: `DatabaseHelper\.Instance`
- æ›¿æ¢: `Gvar.DB`
- å‹¾é€‰"ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"

#### 3. ConfigManager é…ç½®ç®¡ç†å™¨

**æŸ¥æ‰¾**: `ConfigManager.Instance`  
**æ›¿æ¢**: `Gvar.Config`

```csharp
// ä¿®æ”¹å‰
ConfigManager.Instance.GetValue("System", "LogRetentionDays");
ConfigManager.Instance.SetValue("System", "AutoBackup", "true");

// ä¿®æ”¹å
Gvar.Config.GetValue("System", "LogRetentionDays");
Gvar.Config.SetValue("System", "AutoBackup", "true");
```

**æ‰¹é‡æ›¿æ¢å‘½ä»¤**ï¼ˆVS Codeï¼‰:
- æŸ¥æ‰¾: `ConfigManager\.Instance`
- æ›¿æ¢: `Gvar.Config`
- å‹¾é€‰"ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"

#### 4. MqttService MQTT æœåŠ¡

**æŸ¥æ‰¾**: `MqttService.Instance`  
**æ›¿æ¢**: `Gvar.Mqtt`

```csharp
// ä¿®æ”¹å‰
MqttService.Instance.ConnectAsync();
MqttService.Instance.PublishAsync("topic", "message");
bool connected = MqttService.Instance.IsConnected;

// ä¿®æ”¹å
Gvar.Mqtt.ConnectAsync();
Gvar.Mqtt.PublishAsync("topic", "message");
bool connected = Gvar.Mqtt.IsConnected;
```

**æ‰¹é‡æ›¿æ¢å‘½ä»¤**ï¼ˆVS Codeï¼‰:
- æŸ¥æ‰¾: `MqttService\.Instance`
- æ›¿æ¢: `Gvar.Mqtt`
- å‹¾é€‰"ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"

---

### ç¬¬ä¸‰é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘è¿ç§»

#### 1. ç”Ÿäº§ç»Ÿè®¡æ•°æ®

**åŸæœ‰æ–¹å¼**ï¼ˆæ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼‰:
```csharp
private void UpdateProductionStats()
{
    // æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼Œæ€§èƒ½è¾ƒå·®
    string sql = "SELECT COUNT(*) FROM ProductionData WHERE date(ProductionTime) = date('now')";
    int totalCount = Convert.ToInt32(DatabaseHelper.Instance.ExecuteScalar(sql));
    
    sql = "SELECT COUNT(*) FROM ProductionData WHERE date(ProductionTime) = date('now') AND Result = 'OK'";
    int okCount = Convert.ToInt32(DatabaseHelper.Instance.ExecuteScalar(sql));
    
    // è®¡ç®—è‰¯ç‡
    double yieldRate = totalCount > 0 ? (double)okCount / totalCount * 100 : 0;
    
    lblTotalCount.Text = totalCount.ToString();
    lblOkCount.Text = okCount.ToString();
    lblYieldRate.Text = $"{yieldRate:F2}%";
}
```

**æ–°æ–¹å¼**ï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼Œæ€§èƒ½æå‡ï¼‰:
```csharp
private void UpdateProductionStats()
{
    // ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆ5ç§’å†…åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼‰
    lblTotalCount.Text = Gvar.Production.TodayTotalCount.ToString();
    lblOkCount.Text = Gvar.Production.TodayOkCount.ToString();
    lblNgCount.Text = Gvar.Production.TodayNgCount.ToString();
    lblYieldRate.Text = $"{Gvar.Production.TodayYieldRate:F2}%";
}

// æ’å…¥æ–°æ•°æ®ååˆ·æ–°ç¼“å­˜
private void InsertProductionData(ProductionData data)
{
    Gvar.DB.ExecuteNonQuery("INSERT INTO ProductionData ...");
    Gvar.Production.RefreshCache(); // ç«‹å³åˆ·æ–°ç¼“å­˜
}
```

#### 2. è®¾å¤‡è¿æ¥çŠ¶æ€

**åŸæœ‰æ–¹å¼**ï¼ˆåˆ†æ•£çš„ bool å˜é‡ï¼‰:
```csharp
// åœ¨å„ä¸ªçª—ä½“ä¸­åˆ†åˆ«å®šä¹‰
private bool isPlcConnected = false;
private bool isVisionConnected = false;

// éœ€è¦æ‰‹åŠ¨åŒæ­¥çŠ¶æ€
private void OnPlcConnected()
{
    isPlcConnected = true;
    // éœ€è¦é€šçŸ¥å…¶ä»–çª—ä½“...
}
```

**æ–°æ–¹å¼**ï¼ˆé›†ä¸­ç®¡ç†ï¼‰:
```csharp
// åœ¨è®¾å¤‡è¿æ¥äº‹ä»¶ä¸­è®¾ç½®
private void OnPlcConnected(object sender, EventArgs e)
{
    Gvar.Communication.IsPlcConnected = true;
    UpdateConnectionStatus();
}

// åœ¨ä»»ä½•çª—ä½“ä¸­éƒ½å¯ä»¥è®¿é—®
private void UpdateUI()
{
    if (Gvar.Communication.IsAllCriticalDevicesConnected)
    {
        btnStartProduction.Enabled = true;
        statusLabel.Text = "è®¾å¤‡å°±ç»ª";
        statusLabel.ForeColor = Color.Green;
    }
}

// è·å–çŠ¶æ€æ‘˜è¦
private void ShowConnectionSummary()
{
    string summary = Gvar.Communication.GetConnectionSummary();
    MessageBox.Show(summary);
}
```

#### 3. æƒé™æ§åˆ¶

**åŸæœ‰æ–¹å¼**ï¼ˆæ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼‰:
```csharp
private void CheckPermission()
{
    string sql = "SELECT Role FROM Users WHERE Username = @username";
    string role = DatabaseHelper.Instance.ExecuteScalar(sql, ...).ToString();
    
    if (role == "admin")
    {
        btnDeleteRecord.Enabled = true;
    }
}
```

**æ–°æ–¹å¼**ï¼ˆç¼“å­˜æƒé™ç­‰çº§ï¼‰:
```csharp
// ç™»å½•æ—¶è®¾ç½®
private void OnLoginSuccess(string username)
{
    Gvar.User = username;
    Gvar.Permission.CurrentUserLevel = Gvar.DB.GetUserPermissionLevel(username);
    
    UpdateUIPermissions();
}

// ä½¿ç”¨è¯­ä¹‰åŒ–å±æ€§
private void UpdateUIPermissions()
{
    btnDeleteRecord.Enabled = Gvar.Permission.IsAdmin;
    btnEditConfig.Enabled = Gvar.Permission.IsAdmin;
    btnStartProduction.Enabled = Gvar.Permission.IsOperator;
    
    menuItemPermissionManagement.Visible = Gvar.Permission.IsAdmin;
}

// æ³¨é”€æ—¶æ¸…é™¤ç¼“å­˜
private void Logout()
{
    Gvar.User = "";
    Gvar.Permission.ClearCache();
}
```

---

### ç¬¬å››é˜¶æ®µï¼šæ–°åŠŸèƒ½åº”ç”¨

#### 1. ä¸´æ—¶æ•°æ®ä¼ é€’

**åŸæœ‰æ–¹å¼**ï¼ˆé€šè¿‡æ„é€ å‡½æ•°æˆ–å…¬å…±å±æ€§ï¼‰:
```csharp
// çª—ä½“ A
public class FormA : Form
{
    private void OpenFormB()
    {
        var formB = new FormB(productId: 12345, editMode: true);
        formB.ShowDialog();
    }
}

// çª—ä½“ B
public class FormB : Form
{
    private int productId;
    private bool editMode;
    
    public FormB(int productId, bool editMode)
    {
        this.productId = productId;
        this.editMode = editMode;
        InitializeComponent();
    }
}
```

**æ–°æ–¹å¼**ï¼ˆä½¿ç”¨ TempDataï¼‰:
```csharp
// çª—ä½“ A
public class FormA : Form
{
    private void OpenFormB()
    {
        Gvar.TempData.Set("SelectedProductId", 12345);
        Gvar.TempData.Set("EditMode", true);
        
        var formB = new FormB();
        formB.ShowDialog();
        
        // çª—ä½“å…³é—­åæ¸…é™¤
        Gvar.TempData.Clear("SelectedProductId");
        Gvar.TempData.Clear("EditMode");
    }
}

// çª—ä½“ B
public class FormB : Form
{
    private void FormB_Load(object sender, EventArgs e)
    {
        int productId = Gvar.TempData.Get<int>("SelectedProductId");
        bool editMode = Gvar.TempData.Get<bool>("EditMode");
        
        LoadProductData(productId);
        SetEditMode(editMode);
    }
}
```

#### 2. UI çŠ¶æ€ç®¡ç†

```csharp
// åœ¨ Program.cs ä¸­
static void Main()
{
    Application.EnableVisualStyles();
    Application.SetCompatibleTextRenderingDefault(false);
    Application.Run(Gvar.UI.MainForm = new MainForm());
}

// åœ¨ä»»ä½•å­çª—ä½“ä¸­è®¿é—®ä¸»çª—ä½“
private void ReturnToMainForm()
{
    Gvar.UI.MainForm?.BringToFront();
    this.Close();
}
```

---

## ğŸ”§ è¿ç§»å·¥å…·è„šæœ¬

### Visual Studio Code æ‰¹é‡æ›¿æ¢

1. æ‰“å¼€ VS Code
2. æŒ‰ `Ctrl+Shift+H`ï¼ˆæˆ– `Cmd+Shift+H` on Macï¼‰æ‰“å¼€å…¨å±€æ›¿æ¢
3. ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ›¿æ¢ï¼š

```
# æ›¿æ¢ 1: Logger
æŸ¥æ‰¾: Logger\.GetInstance\(\)
æ›¿æ¢: Gvar.Logger
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs

# æ›¿æ¢ 2: DatabaseHelper
æŸ¥æ‰¾: DatabaseHelper\.Instance
æ›¿æ¢: Gvar.DB
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs

# æ›¿æ¢ 3: ConfigManager
æŸ¥æ‰¾: ConfigManager\.Instance
æ›¿æ¢: Gvar.Config
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs

# æ›¿æ¢ 4: MqttService
æŸ¥æ‰¾: MqttService\.Instance
æ›¿æ¢: Gvar.Mqtt
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs

# æ›¿æ¢ 5: æ—§ç”¨æˆ·å˜é‡
æŸ¥æ‰¾: Gvar\._User
æ›¿æ¢: Gvar.User
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs

# æ›¿æ¢ 6: æ—§å·¥ç«™å˜é‡
æŸ¥æ‰¾: Gvar\._CurrentStation
æ›¿æ¢: Gvar.CurrentStation
é€‰é¡¹: â˜‘ æ­£åˆ™è¡¨è¾¾å¼, â˜‘ åŒºåˆ†å¤§å°å†™
æ–‡ä»¶: **/*.cs
```

### éªŒè¯è„šæœ¬

```powershell
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ—§æ–¹å¼çš„è°ƒç”¨
Get-ChildItem -Path "COTUI" -Filter "*.cs" -Recurse | 
    Select-String -Pattern "(Logger\.GetInstance|DatabaseHelper\.Instance|ConfigManager\.Instance|MqttService\.Instance|Gvar\._User|Gvar\._CurrentStation)" |
    Group-Object Pattern | 
    Select-Object Count, Name

# å¦‚æœè¾“å‡ºä¸ºç©ºï¼Œè¯´æ˜è¿ç§»å®Œæˆ
```

---

## âœ… è¿ç§»éªŒè¯æ¸…å•

### ç¼–è¯‘æ£€æŸ¥
- [ ] é¡¹ç›®èƒ½å¤ŸæˆåŠŸç¼–è¯‘
- [ ] æ²¡æœ‰ç¼–è¯‘é”™è¯¯
- [ ] ç¼–è¯‘è­¦å‘Šå·²å¤„ç†ï¼ˆObsolete è­¦å‘Šï¼‰

### åŠŸèƒ½æµ‹è¯•
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æƒé™æ§åˆ¶æ­£å¸¸
- [ ] ç”Ÿäº§æ•°æ®ç»Ÿè®¡æ­£å¸¸
- [ ] è®¾å¤‡è¿æ¥çŠ¶æ€æ­£å¸¸
- [ ] MQTT é€šä¿¡æ­£å¸¸
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] é…ç½®è¯»å†™æ­£å¸¸

### æ€§èƒ½æµ‹è¯•
- [ ] ä»ªè¡¨ç›˜åˆ·æ–°æµç•…ï¼ˆä¸å¡é¡¿ï¼‰
- [ ] æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°å‡å°‘ï¼ˆé€šè¿‡æ—¥å¿—éªŒè¯ï¼‰
- [ ] å†…å­˜å ç”¨æ­£å¸¸

---

## ğŸ“Š è¿ç§»æ•ˆæœå¯¹æ¯”

### ä»£ç å¯è¯»æ€§

**ä¿®æ”¹å‰**:
```csharp
private void SaveData()
{
    Logger.GetInstance().Info("å¼€å§‹ä¿å­˜æ•°æ®");
    DatabaseHelper.Instance.ExecuteNonQuery("INSERT INTO ...");
    ConfigManager.Instance.SetValue("System", "LastSaveTime", DateTime.Now.ToString());
    MqttService.Instance.PublishAsync("data/saved", "success");
}
```

**ä¿®æ”¹å**:
```csharp
private void SaveData()
{
    Gvar.Logger.Info("å¼€å§‹ä¿å­˜æ•°æ®");
    Gvar.DB.ExecuteNonQuery("INSERT INTO ...");
    Gvar.Config.SetValue("System", "LastSaveTime", DateTime.Now.ToString());
    Gvar.Mqtt.PublishAsync("data/saved", "success");
}
```

**æ”¹è¿›**:
- âœ… ä»£ç æ›´ç®€æ´ï¼ˆå‡å°‘ 30% å­—ç¬¦ï¼‰
- âœ… è¯­ä¹‰æ›´æ¸…æ™°ï¼ˆGvar å‰ç¼€ç»Ÿä¸€ï¼‰
- âœ… æ˜“äºç†è§£ï¼ˆç›´è§‚çš„å‘½åï¼‰

### æ€§èƒ½æå‡

**åœºæ™¯**: ä»ªè¡¨ç›˜æ¯ç§’åˆ·æ–°ç”Ÿäº§ç»Ÿè®¡

**ä¿®æ”¹å‰**:
```
æ¯ç§’æŸ¥è¯¢æ•°æ®åº“ 3 æ¬¡ï¼ˆæ€»äº§é‡ã€åˆæ ¼æ•°ã€ä¸è‰¯æ•°ï¼‰
1 åˆ†é’Ÿ = 180 æ¬¡æŸ¥è¯¢
1 å°æ—¶ = 10,800 æ¬¡æŸ¥è¯¢
```

**ä¿®æ”¹å**:
```
æ¯ 5 ç§’æŸ¥è¯¢æ•°æ®åº“ 3 æ¬¡ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
1 åˆ†é’Ÿ = 36 æ¬¡æŸ¥è¯¢
1 å°æ—¶ = 2,160 æ¬¡æŸ¥è¯¢
```

**æ€§èƒ½æå‡**: å‡å°‘ 80% æ•°æ®åº“æŸ¥è¯¢

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜ä¸€è‡´æ€§

å¦‚æœæ‰‹åŠ¨åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹æ•°æ®ï¼ˆä¸é€šè¿‡ç¨‹åºï¼‰ï¼Œéœ€è¦è°ƒç”¨ `RefreshCache()`:

```csharp
// å¤–éƒ¨ä¿®æ”¹äº†ç”Ÿäº§æ•°æ®
Gvar.Production.RefreshCache();
```

### 2. å¤šçº¿ç¨‹è®¿é—®

`Gvar` ä¸­çš„é™æ€å±æ€§æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆå•ä¾‹æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰ï¼Œä½†ç¼“å­˜åˆ·æ–°æ“ä½œéœ€è¦æ³¨æ„ï¼š

```csharp
// âœ… å®‰å…¨ï¼šå•çº¿ç¨‹åˆ·æ–°
Gvar.Production.RefreshCache();

// âš ï¸ æ³¨æ„ï¼šå¤šçº¿ç¨‹åŒæ—¶åˆ·æ–°ï¼ˆå¯èƒ½å¯¼è‡´é‡å¤æŸ¥è¯¢ï¼‰
Task.Run(() => Gvar.Production.RefreshCache());
Task.Run(() => Gvar.Production.RefreshCache());
```

### 3. TempData æ¸…ç†

ä½¿ç”¨ `TempData` ååŠ¡å¿…æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼š

```csharp
// âœ… æ¨èï¼šä½¿ç”¨ try-finally
try
{
    Gvar.TempData.Set("Key", value);
    DoSomething();
}
finally
{
    Gvar.TempData.Clear("Key");
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **ç¼–è¯‘é”™è¯¯**ï¼šç¡®ä¿å¼•ç”¨äº† `COTUI.é€šç”¨åŠŸèƒ½ç±»` å’Œ `COTUI.æ•°æ®åº“` å‘½åç©ºé—´
2. **è¿è¡Œæ—¶é”™è¯¯**ï¼šç¡®ä¿æ•°æ®åº“è¡¨ç»“æ„å·²åˆ›å»ºï¼ˆ`DatabaseHelper` ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
3. **æ€§èƒ½é—®é¢˜**ï¼šæ£€æŸ¥ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆé€šè¿‡æ—¥å¿—æŸ¥çœ‹æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼‰

---

**æœ€åæ›´æ–°**: 2025-11-29  
**ç‰ˆæœ¬**: 1.0.0
